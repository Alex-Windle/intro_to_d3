<!DOCTYPE html>
<html>
    <head>
        <script src="https://d3js.org/d3.v4.min.js"></script> 
        <style>
            .chart rect {
                fill: steelblue;
                opacity: 0.9;
            }
            .axis text {
                font: 15px sans-serif;
            }
            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }
        </style>
    </head>
    <body>
        <svg class="chart"></svg>
        <script>
            var jsonData = [
            {
                "qi": "STATTYPE",
                "yr": "YR1",
                "sc1": "CAT1",
                "s1": "BO1",
                "rs": "Q6HEAR",
                "dvt": "AGEADJPREV",
                "dv": 4.5,
                "lci": 4,
                "hci": 5,
                "wn": 1335697
            },
            {
                "qi": "STATTYPE",
                "yr": "YR1",
                "sc1": "CAT1",
                "s1": "BO1",
                "rs": "Q6VIS",
                "dvt": "AGEADJPREV",
                "dv": 4.2,
                "lci": 3.7,
                "hci": 4.7,
                "wn": 1236853
            },
            {
                "qi": "STATTYPE",
                "yr": "YR1",
                "sc1": "CAT1",
                "s1": "BO1",
                "rs": "Q6SEL",
                "dvt": "AGEADJPREV",
                "dv": 3.3,
                "lci": 2.9,
                "hci": 3.8,
                "wn": 993955
            },
            {
                "qi": "STATTYPE",
                "yr": "YR1",
                "sc1": "CAT1",
                "s1": "BO1",
                "rs": "Q6IND",
                "dvt": "AGEADJPREV",
                "dv": 5.8,
                "lci": 5.2,
                "hci": 6.4,
                "wn": 1682258
            },
            {
                "qi": "STATTYPE",
                "yr": "YR1",
                "sc1": "CAT1",
                "s1": "BO1",
                "rs": "Q6DIS1",
                "dvt": "AGEADJPREV",
                "dv": 22.3,
                "lci": 21.3,
                "hci": 23.3,
                "wn": 6479729
            },
            {
                "qi": "STATTYPE",
                "yr": "YR1",
                "sc1": "CAT1",
                "s1": "BO1",
                "rs": "Q6DIS2",
                "dvt": "AGEADJPREV",
                "dv": 77.7,
                "lci": 76.7,
                "hci": 78.7,
                "wn": 21821005
            },
            {
                "qi": "STATTYPE",
                "yr": "YR1",
                "sc1": "CAT1",
                "s1": "BO1",
                "rs": "Q6COG",
                "dvt": "AGEADJPREV",
                "dv": 9.5,
                "lci": 8.8,
                "hci": 10.2,
                "wn": 2718561
            },
            {
                "qi": "STATTYPE",
                "yr": "YR1",
                "sc1": "CAT1",
                "s1": "BO1",
                "rs": "Q6MOB",
                "dvt": "AGEADJPREV",
                "dv": 11.2,
                "lci": 10.5,
                "hci": 12,
                "wn": 3358303
            }
        ]; 
            //extract datasets
            var dataValues = [];
            var categoryTitles = []; 
            var confidenceIndicators = []; 
            jsonData.forEach(function (obj) {
                var value = obj.dv; 
                var category = obj.rs;
                var confidenceIndicator = {
                    lci: obj.lci, 
                    hci: obj.hci
                }; 
                dataValues.push(value); 
                categoryTitles.push(category);
                confidenceIndicators.push(confidenceIndicator);
            });  
            console.log("Data values: ", dataValues);
            console.log("Confidence indicators (low-high): ", confidenceIndicators);

            //vertical chart
            var margin = {top: 30, right: 0, bottom: 100, left: 50};
            var width = 700 - margin.left - margin.right;
            var height = 700 - margin.top - margin.bottom;
            var spaceFromTop = height + margin.top; 

            //scale
            var x = d3.scaleBand()
                .domain(categoryTitles)
                .rangeRound([0, width]) //total width 
                .padding(0.1);
            var y = d3.scaleLinear()
                .domain([0, d3.max(dataValues)])
                .range([height, 0]);
            
            //chart
            var chart = d3.select(".chart")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom); 
            var bar = chart.selectAll("g") //grouping includes bar & text          
                .data(categoryTitles)
                .enter()
                .append("g")
                //position bars left to right, swap x and y coordinates for vertical 
                .attr("transform", function (d) {
                    var spaceLeft = x.bandwidth() + x(d);
                    return "translate(" + spaceLeft + ", " + margin.top + ")";  
                }); 
            bar.append("rect")
                .data(dataValues)
                .attr("y", function (d) { return y(d); }) //y coordinate
                .attr("height", function (d) { return height - y(d); }) //height
                .attr("width", function (d, i) { return x.bandwidth() / 3; });
            bar.append("line")
                .data(confidenceIndicators)
                .attr("x1", function () { return x.bandwidth() / 6; })
                .attr("y1", function (d) { return y(d.lci); }) //start line
                .attr("x2", function () { return x.bandwidth() / 6; }) //end line
                .attr("y2", function (d) { return y(d.hci); })
                .style("stroke", "black");
         
            //axes
            var xAxis = chart.append("g")
                .attr("class", "axis")             
                .attr("transform", "translate(" + margin.left + ", " + spaceFromTop + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-65)");
            var yAxis = chart.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + margin.left + ", " + margin.top + ")")
                .call(d3.axisLeft(y));
        </script>
    </body>
</html>
